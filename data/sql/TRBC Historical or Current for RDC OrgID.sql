/*
#### TRBC Historical or Current for a given ORGID ###

This query pulls out all the TRBC current or historical classifications for a given ORGID
    
*/


WITH TRBC AS(
SELECT * FROM RDCTRBCInfoChg I
WHERE TRBCId = (SELECT TRBCId FROM RDCTRBCInfoChg I1 
WHERE I.HierarchicalId = I1.HierarchicalId
AND I1.StartDate = (SELECT MAX(StartDate) FROM RDCTRBCInfoChg I2 WHERE I1.HierarchicalId = I2.HierarchicalId))
)
SELECT DISTINCT D.OrgId,D.TRBCId, D.StartDate, D.EndDate,
CASE WHEN LEN(ECON.HIERARCHICALID) = 2 THEN ECON.HIERARCHICALID ELSE NULL END AS EconID,
CASE WHEN LEN(ECON.HIERARCHICALID) = 2 THEN ECON.Title ELSE NULL END AS EconDesc,
CASE WHEN LEN(BUS.HIERARCHICALID) = 4 THEN BUS.HIERARCHICALID ELSE NULL END AS BusID,
CASE WHEN LEN(BUS.HIERARCHICALID) = 4 THEN BUS.Title ELSE NULL END AS BusDesc,
CASE WHEN LEN(GRP.HIERARCHICALID) = 6 THEN GRP.HIERARCHICALID ELSE NULL END AS GrpID,
CASE WHEN LEN(GRP.HIERARCHICALID) = 6 THEN GRP.Title ELSE NULL END AS GrpDesc,
CASE WHEN LEN(IND.HIERARCHICALID) = 8 THEN IND.HIERARCHICALID ELSE NULL END AS IndID,
CASE WHEN LEN(IND.HIERARCHICALID) = 8 THEN IND.Title ELSE NULL END AS IndDesc,
CASE WHEN LEN(ACT.HIERARCHICALID) = 10 THEN ACT.HIERARCHICALID ELSE NULL END AS ActID,
CASE WHEN LEN(ACT.HIERARCHICALID) = 10 THEN ACT.Title ELSE NULL END AS ActDesc
FROM RDCTRBCData D
JOIN RDCTRBCInfoChg ACT
ON D.TRBCId = ACT.TRBCId
AND (D.StartDate BETWEEN ACT.StartDate AND ISNULL(ACT.EndDate,'2050-01-01')
OR ACT.StartDate BETWEEN D.StartDate AND ISNULL(D.EndDate,'2050-01-01'))
JOIN TRBC ECON ON LEFT(ACT.HierarchicalId,2) = ECON.HierarchicalId
JOIN TRBC BUS ON LEFT(ACT.HierarchicalId,4) = BUS.HierarchicalId
JOIN TRBC GRP ON LEFT(ACT.HierarchicalId,6) = GRP.HierarchicalId
JOIN TRBC IND ON LEFT(ACT.HierarchicalId,8) = IND.HierarchicalId
WHERE D.OrgId in (4572184,
17930167,
10817993,
17120529,
13221199,
10817997,
17414736,
19175184,
16917299,
7896974)
AND D.EndDate is NULL -- Comment if you want historical TRBC Industry Changes
ORDER BY OrgID, StartDate
 